generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProductOptionGroupType {
  REMOVE_INGREDIENTS
  COOKING
}

enum OrderStatus {
  NOUVELLE
  EN_PREPA
  PRETE
  SERVIE
  ANNULEE
}

enum ProductKind {
  STANDARD
  MEAT
}

model Establishment {
  id            String         @id @default(cuid())
  name          String
  slug          String         @unique
  timezone      String
  tables        LocationTable[]
  categories    Category[]
  products      Product[]
  orders        Order[]
  adminUsers    AdminUser[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model LocationTable {
  id              String        @id @default(cuid())
  establishmentId String
  label           String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  orders          Order[]

  @@index([establishmentId])
}

model Category {
  id              String        @id @default(cuid())
  establishmentId String
  name            String
  sortOrder       Int
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  products        Product[]

  @@index([establishmentId, sortOrder])
}

model Product {
  id              String               @id @default(cuid())
  establishmentId String
  categoryId      String
  name            String
  description     String
  price           Int
  isActive        Boolean              @default(true)
  sortOrder       Int
  kind            ProductKind          @default(STANDARD)
  establishment   Establishment        @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  category        Category             @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  optionGroups    ProductOptionGroup[]
  orderItems      OrderItem[]

  @@index([establishmentId, categoryId, sortOrder])
}

model ProductOptionGroup {
  id        String                 @id @default(cuid())
  productId String
  name      String
  type      ProductOptionGroupType
  rules     Json
  product   Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Order {
  id              String      @id @default(cuid())
  establishmentId String
  tableId         String
  status          OrderStatus @default(NOUVELLE)
  total           Int
  seen            Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  table           LocationTable @relation(fields: [tableId], references: [id], onDelete: Restrict)
  items           OrderItem[]

  @@index([establishmentId, status, createdAt])
}

model OrderItem {
  id            String   @id @default(cuid())
  orderId       String
  productId     String
  qty           Int
  unitPrice     Int
  notes         String?
  chosenOptions Json
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
}

model AdminUser {
  id              String        @id @default(cuid())
  establishmentId String
  email           String        @unique
  passwordHash    String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
}
